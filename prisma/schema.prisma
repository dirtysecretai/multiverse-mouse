// Complete Prisma schema with authentication and AI model tracking
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String?  // Made optional to allow migration of existing users
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  sessions          Session[]
  tickets           Ticket?
  generatedImages   GeneratedImage[]
  ticketPurchases   TicketPurchase[]
  galleryAccesses   GalleryAccess[]
  purchases         Purchase[]
  discountUsages    DiscountUsage[]
}

model Session {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
}

// ============================================
// TICKET SYSTEM (for AI generation)
// ============================================

model Ticket {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  balance     Int      @default(0) // Current available tickets
  totalBought Int      @default(0) // Lifetime purchased
  totalUsed   Int      @default(0) // Lifetime consumed
  updatedAt   DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TicketPurchase {
  id              Int      @id @default(autoincrement())
  userId          Int
  ticketsCount    Int      // Number of tickets purchased
  amount          Float    // Price paid
  paypalOrderId   String   @unique
  paypalPayerId   String?
  paymentStatus   String   @default("completed")
  createdAt       DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// ============================================
// AI GENERATED IMAGES (with model tracking)
// ============================================

model GeneratedImage {
  id         Int      @id @default(autoincrement())
  userId     Int
  prompt     String   @db.Text
  imageUrl   String   // Blob/R2 URL
  model      String   @default("gemini-3-pro-image") // Track which AI model was used
  ticketCost Int      @default(1) // How many tickets this generation cost
  createdAt  DateTime @default(now())
  expiresAt  DateTime // 30 days from creation
  isDeleted  Boolean  @default(false)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([expiresAt])
  @@index([model]) // Index for analytics
}

// ============================================
// EXISTING TABLES (UPDATED)
// ============================================

model SystemState {
  id                      Int      @id @default(autoincrement())
  isShopOpen              Boolean  @default(true)
  isMaintenanceMode       Boolean  @default(false)
  runesMaintenance        Boolean  @default(false)
  echoChamberMaintenance  Boolean  @default(false)
  galleriesMaintenance    Boolean  @default(false)
  promptPacksMaintenance  Boolean  @default(false)
  aiGenerationMaintenance Boolean  @default(false) // Global AI generation toggle
  
  // Per-model maintenance toggles
  geminiProMaintenance    Boolean  @default(false) // Gemini Pro Scanner v3
  geminiFlashMaintenance  Boolean  @default(false) // Gemini Flash Scanner v2.5
  
  updatedAt               DateTime @updatedAt
}

model EchoMessage {
  id          Int      @id @default(autoincrement())
  message     String   @db.Text
  visibleName Boolean  @default(false)
  name        String?
  createdAt   DateTime @default(now())
}

model Product {
  id            Int      @id @default(autoincrement())
  name          String
  description   String   @db.Text
  price         Float
  imageUrl      String
  category      String
  stock         Int      @default(0)
  isActive      Boolean  @default(true)
  productType   String
  slotPosition  Int?
  isSlotActive  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Gallery {
  id                 Int            @id @default(autoincrement())
  title              String
  description        String         @db.Text
  coverImageUrl      String
  coverImagePosition String?        @default("center")
  price              Float          @default(0)
  isActive           Boolean        @default(true)
  isFeatured         Boolean        @default(false)
  accessType         String         @default("free")
  loreIntro          String?        @db.Text
  loreOutro          String?        @db.Text
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  
  images             GalleryImage[]
  accesses           GalleryAccess[]
}

model GalleryImage {
  id         Int      @id @default(autoincrement())
  galleryId  Int
  imageUrl   String
  caption    String?  @db.Text
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  
  @@index([galleryId])
}

model GalleryAccess {
  id        Int       @id @default(autoincrement())
  userId    Int
  galleryId Int
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  
  @@unique([userId, galleryId])
  @@index([userId])
  @@index([galleryId])
}

model Purchase {
  id              Int      @id @default(autoincrement())
  userId          Int
  itemType        String   // "gallery", "ticket", etc.
  itemId          Int?
  amount          Float
  currency        String   @default("USD")
  paypalOrderId   String   @unique
  paypalPayerId   String
  paymentStatus   String
  createdAt       DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model CarouselImage {
  id        Int      @id @default(autoincrement())
  imageUrl  String
  side      String   // 'left' or 'right'
  position  Int      // 0, 1, 2, etc. for ordering
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiscountCode {
  id            Int      @id @default(autoincrement())
  code          String   @unique
  type          String   // 'percentage' or 'fixed'
  value         Float    // e.g., 20 for 20% or $5 off
  isActive      Boolean  @default(true)
  usageLimit    Int?     // null = unlimited
  timesUsed     Int      @default(0)
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  usedBy        DiscountUsage[]
}

model DiscountUsage {
  id              Int          @id @default(autoincrement())
  userId          Int
  discountCodeId  Int
  usedAt          DateTime     @default(now())
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  discountCode    DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, discountCodeId]) // One use per user per code
}

// ============================================
// NOTIFICATIONS (Admin Announcements)
// ============================================

model Notification {
  id          Int      @id @default(autoincrement())
  message     String   @db.Text
  type        String   @default("info") // 'info', 'warning', 'success', 'update'
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
